{# Transaction Journey Form (Budget-like UX). Field names are extracted from the existing working template. #}

<div class="rounded-xl border bg-white p-5 shadow-sm">
  <h2 class="text-lg font-semibold mb-3">Add transaction</h2>

  {% if error %}
    <div class="mb-4 rounded-lg border border-red-200 bg-red-50 px-4 py-3 text-sm text-red-800">
      {{ error }}
    </div>
  {% endif %}

  <!-- Same journey "progress cards" style as budget -->
  <div class="mb-4 grid grid-cols-1 gap-3 md:grid-cols-3">
    <div class="rounded-lg bg-gray-50 p-3 text-sm">
      <div class="font-medium">1) Type</div>
      <div class="text-gray-600">Expense or income</div>
    </div>
    <div class="rounded-lg bg-gray-50 p-3 text-sm">
      <div class="font-medium">2) Category</div>
      <div class="text-gray-600">Pick where it belongs</div>
    </div>
    <div class="rounded-lg bg-gray-50 p-3 text-sm">
      <div class="font-medium">3) Details</div>
      <div class="text-gray-600">Date, amount, description</div>
    </div>
  </div>

  <form action="/transaction" method="post" class="space-y-5" id="tx-journey-form">
    <!-- Step 1: Type -->
    <fieldset class="rounded-lg border p-4">
      <legend class="px-2 text-sm font-semibold text-gray-700">1) What is this?</legend>
      <div class="mt-2 flex flex-wrap gap-3">
        <label class="inline-flex items-center gap-2 rounded-full border px-3 py-2 text-sm cursor-pointer hover:bg-gray-50">
          <input type="radio" name="tx_type" value="expense" class="accent-black" required>
          <span>Expense</span>
        </label>
        <label class="inline-flex items-center gap-2 rounded-full border px-3 py-2 text-sm cursor-pointer hover:bg-gray-50">
          <input type="radio" name="tx_type" value="income" class="accent-black" required>
          <span>Income</span>
        </label>
      </div>
    </fieldset>

    <!-- Step 2: Category -->
    <fieldset class="rounded-lg border p-4" id="tx-step-category" style="display:none;">
      <legend class="px-2 text-sm font-semibold text-gray-700">2) Category</legend>

      <div class="mt-3 grid grid-cols-1 gap-4 md:grid-cols-2">
        <div>
          <label for="tx_category_id" class="block text-sm font-medium text-gray-700">Category *</label>
          <select
            name="category_id"
            id="tx_category_id"
            class="mt-1 w-full rounded-md border px-3 py-2 text-sm"
            hx-get="/transaction/subcategories"
            hx-trigger="change"
            hx-target="#tx_subcategory_id"
            hx-swap="innerHTML"
            required
          >
            <option value="" selected>(select)</option>
            {% for c in categories %}
              <option value="{{ c.id }}">{{ (c.icon or '') ~ ' ' ~ c.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label for="tx_subcategory_id" class="block text-sm font-medium text-gray-700">Subcategory</label>
          <select name="subcategory_id" id="tx_subcategory_id" class="mt-1 w-full rounded-md border px-3 py-2 text-sm">
            <option value="">(none)</option>
          </select>
        </div>
      </div>
    </fieldset>

    <!-- Step 3: Details -->
    <fieldset class="rounded-lg border p-4" id="tx-step-details" style="display:none;">
      <legend class="px-2 text-sm font-semibold text-gray-700">3) Details</legend>

      <div class="mt-3 grid grid-cols-1 gap-4 md:grid-cols-2">
        <div>
          <label class="block text-sm font-medium text-gray-700">Date *</label>
          <input type="date" name="tx_date" id="tx_date" class="mt-1 w-full rounded-md border px-3 py-2 text-sm" required>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Amount *</label>
          <input name="amount_eur" class="mt-1 w-full rounded-md border px-3 py-2 text-sm" placeholder="0.00" required>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Currency</label>
          <select name="currency" class="mt-1 w-full rounded-md border px-3 py-2 text-sm">
            <option value="EUR" selected>EUR</option>
            <option value="USD">USD</option>
            <option value="EGP">EGP</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Description *</label>
          <input name="description" class="mt-1 w-full rounded-md border px-3 py-2 text-sm" placeholder="e.g., Groceries" required>
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm font-medium text-gray-700">Note</label>
          <input name="note" class="mt-1 w-full rounded-md border px-3 py-2 text-sm" placeholder="(optional)">
        </div>
      </div>

      <div class="pt-2">
        <button type="submit" class="rounded-lg bg-black px-4 py-2 text-sm font-semibold text-white hover:bg-gray-800">
          Save
        </button>
      </div>
    </fieldset>
  </form>
</div>

<script>
(function () {
  const typeRadios = document.querySelectorAll('input[name="tx_type"]');
  const stepCategory = document.getElementById("tx-step-category");
  const stepDetails = document.getElementById("tx-step-details");
  const categorySelect = document.getElementById("tx_category_id");

  function updateSteps() {
    const hasType = Array.from(typeRadios).some(r => r.checked);
    stepCategory.style.display = hasType ? "" : "none";

    const hasCategory = hasType && categorySelect && categorySelect.value && categorySelect.value.trim() !== "";
    stepDetails.style.display = hasCategory ? "" : "none";
  }

  typeRadios.forEach(r => r.addEventListener("change", updateSteps));
  if (categorySelect) categorySelect.addEventListener("change", updateSteps);

  updateSteps();
})();
</script>
